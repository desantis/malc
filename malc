#!/bin/sh
set -e

if [ -z "$1" ] ; then
  echo "Usage: $0 [-l] sourcefile.mal [outputexecutable]"
  exit 1
fi

bindir=$(readlink -f $(dirname $0))

# user overridable
MALC=${MALC:-}
MAL_PREFIX=${MAL_PREFIX:-}
MAL_IMPL=$(readlink -f ${MAL_IMPL:-$bindir/mal-interpreter/mal})

leave_llvm=no
if [ "$1" = "-l" ] ; then
  leave_llvm=yes
  shift
fi
compilemode=release
if [ "$1" = "-g" ] ; then
  compilemode=debug
  shift
fi
srcfile="$(readlink -f $1)"
if [ -n "$2" ] ; then
  out="$(readlink -f $2)"
else
  out="$(dirname $srcfile)/$(basename $srcfile .mal)"
fi

if [ -z "$MALC" ] ; then
  ${MAL_PREFIX:+${MAL_PREFIX} }${MAL_IMPL} $bindir/malc.mal $compilemode $bindir $srcfile > $out.ll
else
  $MALC $compilemode $bindir $srcfile > $out.ll
fi

opt -S -O3 $out.ll -o $out.opt.ll
llc -filetype=obj $out.opt.ll -o $out.o
gcc -g $out.o -lgc -lreadline -lstdc++ -o $out
if [ "$leave_llvm" = no ] ; then
  rm -f $out.ll $out.opt.ll
fi
rm -f $out.o
